TEST=0
for i in $TESTFILES
do
  if ! test -e $i.reference
  then
    echo "Unexpected error: file $i.reference is missing." >&2
    TEST=1
  else
    if test -s $i.reference
    then
      if ! ./$i > $i.tmp
      then
        ############################################################
        ##### $i.reference exists but $i returns an error code #####
        ############################################################
        TEST=1
      else
        if ! diff $i.tmp $i.reference > /dev/null
        then
          ##################################################################
          ##### $i.reference exists, $i does not return an error code, #####
          ##### but its output is incorrect.                           #####
          ##################################################################
          TEST=1
        fi
      fi
      test -e $i.tmp && rm $i.tmp
    else
      if ! ./$i > /dev/null
      then
        ###############################################################
        ##### $i.reference is empty but $i returns an error code. #####
        ###############################################################
        TEST=1
      fi
    fi
  fi
done

exit $TEST
